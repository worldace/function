<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>データベースクラス</title>
  <link href="programming.css" rel="stylesheet">
</head>
<body>

<header>
<h1>データベースクラス</h1>

<nav>
<h2>目次</h2>
<ol>
  <li><a href="#初期設定">初期設定</a></li>
  <li><a href="#データベース接続">データベース接続</a></li>
  <li><a href="#テーブル">テーブル</a></li>
  <li><a href="#主キー">主キー</a></li>
  <li><a href="#取得">取得</a></li>
  <li><a href="#行取得">行取得</a></li>
  <li><a href="#列取得">列取得</a></li>
  <li><a href="#セル取得">セル取得</a></li>
  <li><a href="#件数">件数</a></li>
  <li><a href="#全文検索">全文検索</a></li>
  <li><a href="#追加条件">追加条件</a></li>
  <li><a href="#追加">追加</a></li>
  <li><a href="#更新">更新</a></li>
  <li><a href="#削除">削除</a></li>
  <li><a href="#実行">実行</a></li>
  <li><a href="#作成">作成</a></li>
  <li><a href="#インデックス作成">インデックス作成</a></li>
  <li><a href="#トランザクション">トランザクション</a></li>
  <li><a href="#切断">切断</a></li>
  <li><a href="#プレースホルダと割当">プレースホルダと割当</a></li>
  <li><a href="#MySQLと型">MySQLと型</a></li>
  <li><a href="#その他の情報">その他の情報</a></li>
</ol>
</nav>
</header>



<article id="初期設定">

<h1>初期設定 <img src="star.png" width="20" height="20"></h1>

<p><b>SQLiteかMySQLかどちらか一方を選んで、必ずデータベースに接続する前までに設定してください</b></p>

<p>SQLiteの場合は、次のように指定します。</p>

<pre><cite>SQLite用の設定</cite><!--
const 設定 = [
    'データベースドライバー' => 'sqlite:データベースファイルのパス',
];
--></pre>
<ul>
  <li>ファイルが存在しなければ作成されます。(そのディレクトリのパーミッションが書き込み可であること)</li>
  <li>フルパスで指定することを推奨します</li>
  <li>パスには日本語が含まれないようにしてください</li>
</ul>

<p>MySQLの場合は、ホストアドレス・データベース名・ユーザー名・パスワードの4つを指定する必要があります</p>
<pre><cite>MySQL用の設定</cite><!--
const 設定 = [
    'データベースドライバー' => 'mysql:host=ホストアドレス;dbname=データベース名;charset=utf8',
    'データベースユーザー名' => 'ユーザー名',
    'データベースパスワード' => 'パスワード',
];
--></pre>
</article>



<article id="データベース接続">
<h1>データベース接続 <img src="star.png" width="20" height="20"></h1>
<p><a href="#初期設定">初期設定</a>に基づいてデータベースへ接続します。引数にテーブル名を指定してください<br>
<b>この関数は全ての基点となる最も重要な関数です。</b></p>
<pre><cite>データベース接続</cite><!--
$テーブル = データベース("テーブル名");
--></pre>

<p>データベースの接続先を変更するには、引数に接続情報を追加してください</p>

<pre><cite>手動で接続</cite><!--
//SQLiteに接続する
$テーブル = データベース("テーブル名", "sqlite:./test.db");

//MySQLに接続する
$テーブル = データベース("テーブル名", "mysql:host=ホスト名;dbname=データベース名;charset=utf8", "ユーザID", "パスワード");
--></pre>
<h3 id="省略形">省略形</h3>

<p>この関数は省略形に対応しています。<br>
データベース関数の右に矢印を付けると続けて次の関数を実行することができます。</p>

<pre><cite>標準形と省略形</cite><!--
//標準形
$テーブル = データベース("テーブル名");
$テーブル -> 作成();

//省略形
データベース("テーブル名") -> 作成();
--></pre>

<p>中間変数($テーブル)が不要な時には省略形にするのを推奨します</p>
</article>



<article id="テーブル">
<h1>テーブル</h1>

<p>操作対象とするテーブルを変更します</p>
<pre><cite>テーブル変更</cite><!--
$新しいテーブル = $テーブル -> テーブル("新しいテーブル名");
--></pre>

<p><small>この関数は<a href="#省略形">省略形</a>に対応しています</small></p>
</article>



<article id="主キー">
<h1>主キー</h1>
<p>当ライブラリでは簡略化のため<b>主キーの列名は常にid</b>として処理します。<br>
もし現在のテーブルの主キーの列名がid以外の場合は、必ずこの関数を使用して主キー名を設定してください</p>
<pre><cite>主キーを設定</cite><!--
$テーブル -> 主キー("主キー名");
--></pre>

<p><small>この関数は<a href="#省略形">省略形</a>に対応しています</small></p>
</article>



<article id="取得">
<h1>取得</h1>
<p>データベースから複数行取得します。<br>
追加条件については<a href="#追加条件">追加条件の章</a>を参照してください</p>

<pre><cite>取得</cite><!--
$結果 = $テーブル -> 取得($追加条件);

foreach($結果 as $各行){
    print $各行['列名1'];
    print $各行['列名2'];
}
--></pre>

<p>検索結果は配列です。配列の各要素は連想配列であり、列名がキーです。<br>
検索結果が0件の場合は空配列が返ります。</p>
</article>




<article id="行取得">
<h1>行取得</h1>
<p>idを指定してデータベースから1行取得します</p>

<pre><cite>行取得</cite><!--
$結果 = $テーブル -> 行取得($id);

print $結果['列名1'];
print $結果['列名2'];
--></pre>

<p>検索結果は連想配列です。列名がキーです<br>
検索結果が0件の場合は false が返ります。</p>
</article>



<article id="列取得">
<h1>列取得</h1>
<p>列名を指定してデータベースから1列取得します。<br>
追加条件については<a href="#追加条件">こちら</a>を参照してください</p>

<pre><cite>列取得</cite><!--
$結果 = $テーブル -> 列取得($列名, $追加条件);

foreach($結果 as $値){
    print $値;
}
--></pre>

<p>検索結果は配列です。配列の各要素は値です。<br>
検索結果が0件の場合は空配列が返ります。</p>

<p><small>列を複数取得することはできません。<a href="#取得">取得関数</a>で全列を取得してください</small></p>
</article>



<article id="セル取得">
<h1>セル取得</h1>
<p>idと列名を指定してデータベースから1セル取得します</p>

<pre><cite>セル取得</cite><!--
$結果 = $テーブル -> セル取得($id, $列名);

print $結果;
--></pre>

<p>検索結果は値です。<br>
検索結果が0件の場合は false が返ります。</p>
</article>



<article id="件数">
<h1>件数</h1>
<p>データベースから件数を求めます。初期値はテーブルの全行数を取得します。<br>
追加条件については式と割当のみ対応しています。詳しくは<a href="#追加条件">こちら</a>を参照してください</p>

<pre><cite>件数</cite><!--
$結果 = $テーブル -> 件数($追加条件);

print $結果;
--></pre>

<p>検索結果は件数です。</p>
</article>



<article id="全文検索">
<h1>全文検索</h1>
<p>検索ワードと列名を指定してデータベースから文字列検索を行います。</p>

<pre><cite>検索</cite><!--
$結果 = $テーブル -> 全文検索($検索ワード, $検索対象列, $追加条件);

foreach($結果 as $各行){
    print $各行['列名1'];
    print $各行['列名2'];
}
--></pre>

<p>検索ワードが複数ある場合は配列に入れてください。(AND検索になります)</p>

<pre><cite>ユーザ入力の検索文字列を配列に入れる例</cite><!--
$検索ワード = preg_replace("/[[:space:]　]+/u", " ", $検索ワード);
$検索ワード = explode(" ", trim($検索ワード));
--></pre>
<p>検索対象列が複数ある場合も配列に入れてください</p>
<p><small>検索ワードと検索対象列は、1つしかない場合でも配列に入れてOKです</small></p>

<p>追加条件については<a href="#追加条件">こちら</a>を参照してください</p>

<p>検索結果は配列です。配列の各要素は連想配列であり、列名がキーです。<br>
検索結果が0件の場合は空配列が返ります。</p>
</article>



<article id="追加条件">
<h1>追加条件</h1>
<p><a href="#取得">取得関数</a>、<a href="#列取得">列取得関数</a>、<a href="#件数">件数関数</a>、<a href="#検索">検索関数</a>などでは追加条件を指定することで、詳しく検索ができます。<br>
追加条件は<b>連想配列</b>として引数に渡してください</p>
<table>
<tr><th>キー名</th><th>値の説明</th><th>対応関数</th></tr>
<tr><td>位置</td>
<td class="left">取得を開始する位置を0から始まる数字で指定します<br>省略時は0</td>
<td class="left">取得 列取得 検索</td>
</tr>

<tr><td>件数</td>
<td class="left">取得する件数を数字で指定します<br>省略時は31。次ページの存在確認用に+1件しています<br>デフォルト値は定数 設定['データベース件数'] で変更できます<br>全件取得するには∞と指定します</td>
<td class="left">取得 列取得 検索</td>
</tr>

<tr><td>順番</td>
<td class="left">取得する順番を配列で指定します。["対象列", "大きい順<small>または</small>小さい順"]<br>省略時は["id", "大きい順"]です。idの大きい順に取得します</td>
<td class="left">取得 列取得 検索</td>
</tr>

<tr><td>式</td>
<td class="left">追加する条件式。SQLを記述する必要があります<br>SQLを記述する際は<a href="#プレースホルダと割当">プレースホルダと割当</a>をお読みください</td>
<td class="left">全て</td>
</tr>

<tr><td>割当</td>
<td class="left">式のプレースホルダに割り当てる変数を、順番通りに配列へ入れてください<br>MySQLを使用する場合は<a href="#MySQLと型">変数の型</a>に注意してください</td>
<td class="left">全て</td>
</tr>

<tr><td>行タイプ</td>
<td class="left">取得結果における各行の形<br>「連想配列」「配列」「オブジェクト」「任意のクラス名」から選べます<br>省略時は連想配列です。列名がキーとなります</td>
<td class="left">取得 行取得 検索</td>
</tr>
</table>


<pre><cite>追加条件の使用例</cite><!--
//追加条件を指定しない場合は、位置0から31件、idの大きい順に取得します。(最初のページ)
$テーブル -> 取得();

//ここで最後の1件は次ページの存在確認用なので切り捨てます

//次ページを取得します
$テーブル -> 取得(["位置"=>30]);
--></pre>
</article>



<article id="追加">
<h1>追加</h1>

<p>データベースに1行追加します。<br>
追加するデータとして、列名と値からなる連想配列を用意してください</p>

<pre><cite>追加</cite><!--
$追加するデータ = [
    "列名1" => 列名1の値,
    "列名2" => 列名2の値,
];

$結果 = $テーブル -> 追加($追加するデータ);

print $結果;
--></pre>

<p>結果は追加された行のid番号です。</p>
<p><small>MySQLを使用する場合は<a href="#MySQLと型">変数の型</a>に注意してください</small></p>
</article>



<article id="更新">
<h1>更新</h1>

<p>idを指定してデータベースを1行更新します。<br>
更新するデータとして、列名と値からなる連想配列を用意してください</p>

<pre><cite>更新</cite><!--
$更新するデータ = [
    "列名1" => 列名1の値,
    "列名2" => 列名2の値,
];

$結果 = $テーブル -> 更新($id, $更新するデータ);

print $結果;
--></pre>

<p>結果は更新した件数です。</p>

<p><small>更新するデータの値に「データベース式」を利用したい時は、値を連想配列にして["式" =&gt; "～"]としてください<br>
この「データベース式」にはプレースホルダは使用できません。また式の検証もしないので外部からの入力を利用するのは禁止です。</small></p>

<p><small>MySQLを使用する場合は<a href="#MySQLと型">変数の型</a>に注意してください</small></p>
</article>



<article id="削除">
<h1>削除</h1>

<p>idを指定してデータベースから1行削除します</p>

<pre><cite>削除</cite><!--
$結果 = $テーブル -> 削除($id);

print $結果;
--></pre>

<p>結果は削除した件数です。</p>
</article>



<article id="実行">
<h1>実行</h1>

<p>SQL文を指定してデータベースを実行します。</p>

<pre><cite>実行</cite><!--
$結果 = $テーブル -> 実行($SQL文, $割当);
--></pre>

<p>結果は<a href="http://php.net/manual/ja/class.pdostatement.php" target="_blank">PDOStatementオブジェクト</a>です。</p>

<p><small>この関数を利用する場合は<a href="#プレースホルダと割当">プレースホルダと割当</a>と<a href="#MySQLと型">MySQLと型</a>をお読みください</small></p>
</article>



<article id="作成">
<h1>作成</h1>
<p>データベースにテーブルを1つ作成します。</p>
<p>テーブル定義として「列名がキー」「型情報が値」の連想配列を用意してください。<br>
型情報は常にMySQL互換で作成してください。(MySQLの型情報はSQLiteと互換性があるため)</p>
<pre><cite>作成</cite><!--
$テーブル定義 = [
"id"           => "integer primary key auto_increment",
"動画URL"      => "varchar(500) not null",
"横サイズ"     => "smallint unsigned not null",
"縦サイズ"     => "smallint unsigned not null",
"動画時間"     => "float unsigned not null",
"投稿時間"     => "integer unsigned not null",
"アクセス数"   => "integer unsigned default 0",
"コメント数"   => "integer unsigned default 0",
"ユーザID"     => "varchar(250) not null",
"状態"         => "varchar(30) default '公開'",
"タイトル"     => "varchar(250) not null",
"本文"         => "text",
];

$テーブル -> 作成($テーブル定義);
--></pre>
<p>成功すれば true が返ります。失敗すれば false が返ります</p>


<p><small>当ライブラリでは簡略化のため主キーの列名は常にidとして処理するので、<b>主キーの列名はid</b>とするのを推奨します。</small></p>


<p><small>SQLiteでは型情報に「int」を含めばINT型、「char」「text」「clob」を含めばTEXT型、「double」「float」「real」を含めばREAL型、「blob」を含めばNONE型、それ以外はNUMERIC型になります。<br>
integer primary keyの後にautoincremanetをつけると、重複しないidにすることができます。</small></p>


<p>もし追加したい文があれば第2引数に渡してください。<br>
MySQLは初期値が「ENGINE = InnoDB DEFAULT CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci」となっています<br>
SQLiteの初期値はありません</p>
</article>



<article id="インデックス作成">
<h1>インデックス作成</h1>
<p>列名を指定して、その列のインデックスを作成します。<br>
インデックスを作成するとその列を高速に検索できるようになります</p>
<pre><cite>インデックス作成</cite><!--
$テーブル -> インデックス作成($列名);
--></pre>
<p>成功すれば true が返ります。失敗すれば false が返ります</p>
</article>



<article id="トランザクション">
<h1>トランザクション</h1>
<pre><cite>トランザクション</cite><!--
$テーブル -> トランザクション開始(); //開始
$テーブル -> トランザクション終了(); //コミット
$テーブル -> トランザクション失敗(); //巻き戻す
--></pre>
<p><small>この関数は<a href="#省略形">省略形</a>に対応しています</small></p>
</article>



<article id="切断">
<h1>切断</h1>
<p>データベースから切断します。<br>
通常はスクリプト終了で自動的に切断されるので実行する必要はありません</p>
<pre><cite>切断</cite><!--
$テーブル -> 切断(); //現在のデータベースから切断する
--></pre>

<p><small>スクリプトを長時間実行する場合は切断した方がよいでしょう</small></p>
</article>



<article id="プレースホルダと割当">
<h1>プレースホルダと割当</h1>

<p><a href="#実行">実行関数</a>や<a href="#追加条件">追加条件の式</a>ではSQL文を直接記述することができます。この時の注意点を説明します</p>

<h3>プレースホルダを使う</h3>

<p>SQL文に変数を埋め込むことは原則として禁止です。(セキュリティ問題)<br>
必ず変数をプレースホルダ <b>?</b> に置き換えてください。</p>
<pre><!--
//×ダメな例 - SQL文の中に変数が埋め込まれている
$SQL文 = "insert into テーブル名 (列1, 列2, 列3) values ($列1の値, $列2の値, $列3の値)";
$テーブル -> 実行($SQL文);

//○良い例 - 変数をプレースホルダに置き換えている
$SQL文 = "insert into テーブル名 (列1, 列2, 列3) values (?, ?, ?)";
$割当  = [$列1の値, $列2の値, $列3の値];
$テーブル -> 実行($SQL文, $割当);
--></pre>

<p>? に割り当てる変数は順番通りに配列の中に入れて、実行関数の第2引数に渡してください。(1つでも配列に入れる)<br>
プレースホルダを使わない時は、第2引数の割当は省略することができます。</p>

<p><small>当ライブラリは順番タイプのプレースホルダに対応しています。(名前タイプは非対応)</small></p>
</article>



<article id="MySQLと型">
<h1>MySQLと型</h1>

<p>データベースにMySQLを使用する場合、変数の型に注意する必要があります</p>

<pre><!--
//×ダメな例
$更新するデータ = [
    "価格" => $_GET['価格'], //ここに問題が
];

$テーブル -> 更新($更新するデータ);
--></pre>

<p>データベースにおいて"価格"は整数型と定義したとします。<br>
一方、変数$_GET['id']は文字列型とします。<br>
このまま実行すると、整数型と文字列型で不整合となりエラーとなってしまいます。</p>
<p><small>PHPにおいて $_GET や $_POST は常に文字列型となります</small></p>

<p>このように型が不整合となる場合は、PHP側で型変換を行うようにしてください。<br>特にデータベースの型が整数型の時に問題が発生しやすいです。</p>

<pre><!--
//○良い例
$更新するデータ = [
    "価格" => (int)$_GET['価格'], //これで大丈夫
];

//参考
//(int)→整数型に変換、(float)→小数点型に変換、(string)→文字列型に変換、(binary)→バイナリ型に変換
--></pre>



<p>型について注意する箇所は4箇所あります</p>

<ul>
  <li><a href="#追加">追加関数</a>における追加するデータの値</li>
  <li><a href="#更新">更新関数</a>における更新するデータの値</li>
  <li><a href="#実行">実行関数</a>における割当</li>
  <li><a href="#追加条件">追加条件</a>における割当</li>
</ul>



<p><small>SQLiteでは自動的に型変換が行われるのでエラーになりません</small></p>
</article>



<article id="その他の情報">
<h1>その他の情報</h1>
<h3 id="詳細設定">詳細設定</h3>

<p>データベース接続のオプションを定数 設定['データベース詳細'] で指定できます。初期値は次の通りです</p>

<pre><cite>詳細設定の初期値</cite><!--
const 設定['データベース詳細'] = [
    PDO::ATTR_DEFAULT_FETCH_MODE       => PDO::FETCH_ASSOC,       //データ取得時における行タイプは連想配列
    PDO::ATTR_ERRMODE                  => PDO::ERRMODE_EXCEPTION, //エラー時は例外を発生させる
    PDO::ATTR_EMULATE_PREPARES         => true,                   //準備文の処理はPHP側で行う(高速)
    PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => true,                   //持続的な接続を行う(高速)
];
--></pre>
<p>詳細設定は上記の初期値に結合され、データベース接続時に使用します。(PDOコンストラクタの第4引数に渡される)</p>


<h3>定義クラスについて</h3>

<p>定義クラスとは「テーブル名＋定義」という名前のクラスのことです</p>

<p>このクラスに「定義」という定数を記述しておくと、追加時や更新時に定義クラスのオブジェクトを渡すことにより自動的に型変換を行う機能があります</p>


<pre><cite>利用例</cite><!--
class テスト定義{
    const 定義 = [ //テーブル作成関数の第1引数に渡すものと同等
        "id"    => "integer primary key auto_increment",
        "文字"  => "varchar(500)",
        "数字"  => "integer",
    ];
    
    public $id;
    public $文字;
    public $数字;
}

//テーブル作成
データベース("テスト")->作成(テスト定義::定義);

//データ追加
$テスト = new テスト定義;
$テスト->文字 = "あいうえお";
$テスト->数字 = "12345"; //型が不整合

データベース("テスト")->追加($テスト); //テスト定義のオブジェクトを渡しているので自動的に型変換される
--></pre>
<h3>行タイプで定義クラスを利用する</h3>

<p>次のうちどちらかの条件を満たすと、データ取得時において、各行のデータが定義クラスのオブジェクトにセットされます</p>
<ul>
  <li><a href="#詳細設定">詳細設定</a>において「PDO::ATTR_DEFAULT_FETCH_MODE」に「PDO::FETCH_CLASS」を指定した時は、<br>定義クラスを自動的に読み込みます</li>
  <li><a href="#追加条件">追加条件</a>の行タイプにおいてクラス名を直接指定する。 ["行タイプ" =&gt; "クラス名"]</li>
</ul>

<pre><cite>利用例</cite><!--
foreach(データベース("テスト")->取得() as $テスト){
    print $テスト->文字;
    print $テスト->数字;
}
--></pre>

</article>

<footer>
<nav><a href="./">ホームに戻る</a></nav>
</footer>

<script src="programming.js"></script>

</body></html>